<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>TRANSCENDANCE : EXOCORTEX Beta 1.0.2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #010102; --sidebar-bg: #050508; --border: rgba(255,255,255,0.08); --accent: #fbbf24; }
        html, body { margin: 0; padding: 0; width: 100vw; height: 100dvh; background-color: var(--bg); overflow: hidden; position: fixed; font-family: 'JetBrains Mono', monospace; color: white; }
        #viewport { position: absolute; inset: 0; display: flex; }
        aside { width: 220px; height: 100%; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 20; }
        .brand-header { padding: 15px; border-bottom: 1px solid var(--border); }
        .brand-title { font-size: 10px; font-weight: 900; letter-spacing: 0.15em; color: #666; text-transform: uppercase; }
        .brand-version { color: #10b981; }
        #flux-container { flex: 0 0 35%; border-bottom: 1px solid var(--border); padding: 15px; overflow: hidden; display: flex; flex-direction: column; }
        .section-title { font-size: 10px; color: var(--accent); font-weight: 800; text-transform: uppercase; margin-bottom: 8px; display: flex; justify-content: space-between; }
        #activity-list { overflow-y: auto; list-style: none; padding: 0; margin: 0; flex: 1; font-size: 10px; color: #bbb; }
        #legend-container { flex: 1; padding: 15px; overflow-y: auto; }
        .legend-item { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 8px; cursor: pointer; font-size: 9px; font-weight: 700; color: #888; transition: opacity 0.2s; }
        main { flex: 1; position: relative; height: 100%; background: var(--bg); display: flex; flex-direction: column; }
        .top-bar { height: 40px; border-bottom: 1px solid var(--border); display: flex; justify-content: center; align-items: center; }
        .bttf-btn { background: linear-gradient(180deg, #ff9d00 0%, #ffff00 100%); color: black; padding: 5px 12px; border-radius: 2px; font-weight: 900; font-style: italic; transform: skewX(-10deg); font-size: 10px; cursor: pointer; border:none; }
        #loading-screen { position: fixed; inset: 0; background: #010102; z-index: 9000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #detail-card { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 600px; background: rgba(5,5,8,0.98); border: 1px solid #333; padding: 2rem; z-index: 5000; display: none; box-shadow: 0 0 50px #000; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="text-xl font-black text-white mb-2 tracking-widest uppercase">Transcendance Beta 1.0.2</div>
        <div class="text-xs text-zinc-500">Connexion à la Noosphère...</div>
    </div>
    <div id="viewport">
        <aside>
            <div class="brand-header">
                <div class="brand-title">Transcendance <span class="brand-version">Beta 1.0.2</span></div>
            </div>
            <div id="flux-container">
                <div class="section-title"><span>Flux</span><span id="flux-count" class="text-zinc-500">0</span></div>
                <ul id="activity-list" class="scrollbar-hide"></ul>
            </div>
            <div id="legend-container"></div>
        </aside>
        <main>
            <div class="top-bar"><button onclick="resetView()" class="bttf-btn">RETOUR VERS LE FUTUR</button></div>
            <div class="relative flex-1 w-full"><canvas id="loomChart"></canvas></div>
        </main>
    </div>
    <div id="detail-card">
        <button onclick="closeDetail()" class="absolute top-4 right-4 text-zinc-500 hover:text-white text-2xl">&times;</button>
        <h2 id="card-title" class="text-2xl font-black text-amber-500 uppercase mb-4"></h2>
        <p id="card-desc" class="text-zinc-300 italic text-sm mb-6 leading-relaxed"></p>
        <div id="card-analysis" class="grid grid-cols-2 gap-4 text-[10px] border-t border-zinc-800 pt-4">
             <div>PHARMAKON: <br><span id="card-pharma" class="text-zinc-100 font-bold"></span></div>
             <div>S-CURVE: <br>PHASE <span id="card-scurve" class="text-zinc-100 font-bold"></span> / 5</div>
             <div class="col-span-2">CONVERGENCE & GRAND FILTRE: <p id="card-conv" class="text-zinc-400 mt-1 leading-tight"></p></div>
        </div>
    </div>
    <script>
        const CLOUD_URL = 'https://script.google.com/macros/s/AKfycbwg-ZzMeSRyoaTRV-u824eQvnd8tHYxTsk-xDSK4vhYy42OnMpFrpumj2NSEaA45gP-/exec';
        const COLORS = { "⚪ SINGULARITÉ": "#ffffff", "✨ NOOSPHÈRE": "#0ea5e9", "🔮 IMAGINAIRE": "#f472b6", "🟡 HARDWARE": "#fbbf24", "🔵 COGNITION": "#3b82f6", "🔴 RÉSEAU": "#ef4444", "🟣 ESPACE": "#a855f7", "🟢 BIOTECH": "#10b981", "☢️ ENTROPIE": "#f97316", "🏛️ POLITIQUE": "#d946ef", "DEFAUT": "#9ca3af" };
        const ICONS = { "⚪ SINGULARITÉ": "🧠", "✨ NOOSPHÈRE": "🌍", "🔮 IMAGINAIRE": "📚", "🟡 HARDWARE": "💾", "🔵 COGNITION": "⚡", "🔴 RÉSEAU": "🌐", "🟣 ESPACE": "🚀", "🟢 BIOTECH": "🧬", "☢️ ENTROPIE": "☢️", "🏛️ POLITIQUE": "⚖️" };
        let loomChart;

        async function loadData(init = false) {
            try {
                const res = await fetch(CLOUD_URL + '?t=' + Date.now());
                const json = await res.json();
                updateChart(json);
                updateLegend(json);
                updateFlux(json);
                if (init) { 
                    setTimeout(() => {
                        const ls = document.getElementById('loading-screen');
                        if(ls) ls.remove();
                    }, 1200);
                    resetView(); 
                }
            } catch(e) { console.error("Sync Error:", e); }
        }

        function updateChart(data) {
            const datasets = {};
            data.sort((a,b) => a.year - b.year).forEach(d => {
                const cat = d.category || "DEFAUT";
                if (!datasets[cat]) datasets[cat] = { label: cat, borderColor: COLORS[cat], backgroundColor: COLORS[cat], data: [], pointRadius: 4, tension: 0.4, borderWidth: 2 };
                datasets[cat].data.push({ x: d.year, y: d.value, ...d });
            });
            loomChart.data.datasets = Object.values(datasets);
            loomChart.update();
        }

        function updateLegend(data) {
            const container = document.getElementById('legend-container');
            container.innerHTML = '<div class="section-title">STRANDS</div>';
            const counts = {};
            data.forEach(d => counts[d.category] = (counts[d.category] || 0) + 1);
            Object.keys(COLORS).sort().forEach(cat => {
                if (cat === "DEFAUT" || !counts[cat]) return;
                const div = document.createElement('div');
                div.className = 'legend-item';
                div.innerHTML = <span><span style="color:\">●</span> \</span><span class="text-zinc-600">\</span>;
                div.onclick = () => {
                    const ds = loomChart.data.datasets.find(d => d.label === cat);
                    if(ds) { ds.hidden = !ds.hidden; loomChart.update(); div.style.opacity = ds.hidden ? '0.3' : '1'; }
                };
                container.appendChild(div);
            });
        }

        function updateFlux(data) {
            const list = document.getElementById('activity-list');
            list.innerHTML = '';
            document.getElementById('flux-count').innerText = data.length;
            data.slice(-20).reverse().forEach(d => {
                const li = document.createElement('li');
                li.className = "mb-2 leading-tight flex items-start gap-2";
                li.innerHTML = <span style="color:\">\</span> <span>\</span>;
                list.appendChild(li);
            });
        }

        function showDetail(d) {
            document.getElementById('card-title').innerText = d.label;
            document.getElementById('card-desc').innerText = d.description || "Pas de description.";
            document.getElementById('card-pharma').innerText = \% REMÈDE / \% POISON;
            document.getElementById('card-scurve').innerText = d.s_curve_phase || "?";
            document.getElementById('card-conv').innerText = d.convergences || d.grand_filter_analysis || "N/A";
            document.getElementById('detail-card').style.display = 'block';
        }

        function zoomTo(year) { loomChart.options.scales.x.min = year - 10; loomChart.options.scales.x.max = year + 10; loomChart.update(); }
        function resetView() { zoomTo(1985); }
        function closeDetail() { document.getElementById('detail-card').style.display = 'none'; }

        window.onload = () => {
            loomChart = new Chart(document.getElementById('loomChart'), {
                type: 'line',
                data: { datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onClick: (e, el) => { if(el.length) showDetail(loomChart.data.datasets[el[0].datasetIndex].data[el[0].index]); },
                    scales: {
                        x: { type: 'linear', grid: { color: '#111' }, ticks: { color: '#444' } },
                        y: { type: 'linear', position: 'right', grid: { color: '#050505' }, ticks: { display: false } }
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            color: '#fff', font: { size: 9, weight: 'bold' },
                            backgroundColor: c => c.dataset.borderColor,
                            display: (ctx) => {
                                const zoom = ctx.chart.scales.x.max - ctx.chart.scales.x.min;
                                return ctx.dataset.data[ctx.dataIndex].tipping || zoom < 40;
                            },
                            formatter: v => v.label,
                            padding: 3, borderRadius: 2, clip: true
                        },
                        zoom: { zoom: { wheel: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'x' } }
                    }
                }
            });
            loadData(true);
        };
    </script>
</body>
</html>