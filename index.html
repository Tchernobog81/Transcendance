<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>TRANSCENDANCE : Beta 1.1.6</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #010102; --sidebar-bg: #050508; --border: rgba(255,255,255,0.08); --accent: #fbbf24; }
        html, body { margin: 0; padding: 0; width: 100vw; height: 100dvh; background-color: var(--bg); overflow: hidden; position: fixed; font-family: 'JetBrains Mono', monospace; color: white; }
        #viewport { position: absolute; inset: 0; display: flex; opacity: 0; transition: opacity 1s; }
        aside { width: 240px; height: 100%; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 20; }
        .brand-header { padding: 15px; border-bottom: 1px solid var(--border); }
        .brand-title { font-size: 10px; font-weight: 900; letter-spacing: 0.15em; color: #666; text-transform: uppercase; }
        .brand-version { color: #10b981; }
        #flux-container { flex: 0 0 35%; border-bottom: 1px solid var(--border); padding: 15px; overflow: hidden; display: flex; flex-direction: column; }
        .section-title { font-size: 10px; color: var(--accent); font-weight: 800; text-transform: uppercase; margin-bottom: 8px; display: flex; justify-content: space-between; }
        #activity-list { overflow-y: auto; list-style: none; padding: 0; margin: 0; flex: 1; font-size: 10px; color: #bbb; }
        #legend-container { flex: 1; padding: 15px; overflow-y: auto; }
        .legend-item { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 8px; font-size: 9px; font-weight: 700; color: #888; }
        main { flex: 1; position: relative; height: 100%; background: var(--bg); display: flex; flex-direction: column; }
        .top-bar { height: 40px; border-bottom: 1px solid var(--border); display: flex; justify-content: center; align-items: center; z-index: 30; }
        .bttf-btn { background: linear-gradient(180deg, #ff9d00 0%, #ffff00 100%); color: black; padding: 5px 12px; border-radius: 2px; font-weight: 900; font-style: italic; transform: skewX(-10deg); font-size: 10px; cursor: pointer; border: none; }
        #sync-hud { padding: 10px 15px; font-size: 8px; font-weight: bold; border-top: 1px solid var(--border); color: #444; }
        #loading-screen { position: fixed; inset: 0; background: #010102; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s; }
        .boot-title { font-size: 1.5rem; font-weight: 900; letter-spacing: 0.5em; text-transform: uppercase; }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="boot-title">Transcendance</div>
        <div class="text-[10px] text-zinc-600 mt-2 uppercase">NATIVE SYSTEM Beta 1.1.6</div>
        <div id="boot-info" class="text-[10px] text-emerald-500 mt-5">Loading Local DB...</div>
    </div>
    
    <div id="viewport">
        <aside>
            <div class="brand-header">
                <div class="brand-title">Transcendance <span class="brand-version" onclick="location.reload(true)">Beta 1.1.6</span></div>
            </div>
            <div id="flux-container">
                <div class="section-title"><span>Flux Entrant</span><span id="flux-count" class="text-zinc-500">0</span></div>
                <ul id="activity-list"></ul>
            </div>
            <div id="legend-container"></div>
            <div id="sync-hud">NATIVE DB: READY</div>
        </aside>
        <main>
            <div class="top-bar"><button onclick="resetView()" class="bttf-btn">RETOUR VERS LE FUTUR</button></div>
            <div class="relative flex-1 w-full"><canvas id="loomChart"></canvas></div>
        </main>
    </div>

    <script>
        const DATA_URL = "./loom_consolidated_v102.json";
        const COLORS = { "⚪ SINGULARITÉ": "#ffffff", "✨ NOOSPHÈRE": "#0ea5e9", "🔮 IMAGINAIRE": "#f472b6", "🟡 HARDWARE": "#fbbf24", "🔵 COGNITION": "#3b82f6", "🔴 RÉSEAU": "#ef4444", "🟣 ESPACE": "#a855f7", "🟢 BIOTECH": "#10b981", "☢️ ENTROPIE": "#f97316", "🏛️ POLITIQUE": "#d946ef" };
        let loomChart;

        function removeLoading() {
            const ls = document.getElementById('loading-screen');
            const vp = document.getElementById('viewport');
            if(ls) { ls.style.opacity = '0'; setTimeout(function(){ ls.remove(); }, 800); }
            if(vp) vp.style.opacity = '1';
        }

        async function loadData() {
            const hud = document.getElementById('sync-hud');
            try {
                // FETCH LOCAL (No CORS issues)
                const res = await fetch(DATA_URL + '?t=' + Date.now());
                if (!res.ok) throw new Error("File not found");
                const json = await res.json();
                
                hud.innerText = "NATIVE DB: " + json.length + " ITEMS";
                hud.style.color = "#10b981";

                updateChart(json);
                updateLegend(json);
                updateFlux(json);
                setTimeout(removeLoading, 1000);
            } catch(e) { 
                hud.innerText = "DB ERROR: " + e.message;
                hud.style.color = "#ef4444";
                removeLoading();
            }
        }

        function updateChart(data) {
            if(!loomChart) return;
            const datasets = {};
            data.sort(function(a,b){ return a.year - b.year; }).forEach(function(d){
                const cat = d.category || "DEFAUT";
                if (!datasets[cat]) datasets[cat] = { label: cat, borderColor: COLORS[cat] || "#9ca3af", backgroundColor: COLORS[cat] || "#9ca3af", data: [], pointRadius: 4, tension: 0.4 };
                datasets[cat].data.push({ x: d.year, y: d.value, label: d.label });
            });
            loomChart.data.datasets = Object.values(datasets);
            loomChart.update();
        }

        function updateLegend(data) {
            const container = document.getElementById('legend-container');
            const counts = {};
            data.forEach(function(d){ counts[d.category] = (counts[d.category] || 0) + 1; });
            container.innerHTML = '<div class="section-title">STRANDS</div>';
            Object.keys(COLORS).forEach(function(cat){
                if (!counts[cat]) return;
                const div = document.createElement('div');
                div.className = 'legend-item';
                div.innerHTML = '<span>● ' + cat + '</span><span>' + counts[cat] + '</span>';
                container.appendChild(div);
            });
        }

        function updateFlux(data) {
            const list = document.getElementById('activity-list');
            list.innerHTML = '';
            document.getElementById('flux-count').innerText = data.length;
            data.slice(-10).reverse().forEach(function(d){
                const li = document.createElement('li');
                li.className = "mb-2 text-[9px]";
                li.innerHTML = '<span style="color:' + (COLORS[d.category] || '#fff') + '">●</span> ' + d.label;
                list.appendChild(li);
            });
        }

        function resetView() { if(loomChart) { loomChart.options.scales.x.min = 1980; loomChart.options.scales.x.max = 2030; loomChart.update(); } }

        window.onload = function() {
            setTimeout(removeLoading, 5000);
            try {
                const ctx = document.getElementById('loomChart');
                loomChart = new Chart(ctx, {
                    type: 'line', data: { datasets: [] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { x: { type: 'linear', grid: { color: '#111' } }, y: { type: 'linear', position: 'right' } },
                        plugins: { legend: { display: false }, datalabels: { color: '#fff', display: true, formatter: function(v){ return v.label; } } }
                    }
                });
            } catch(e) { console.error(e); }
            loadData();
        };
    </script>
</body>
</html>