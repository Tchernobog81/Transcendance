<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>TRANSCENDANCE : EXOCORTEX v148</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #010102; --sidebar-bg: #050508; --border: rgba(255,255,255,0.08); --accent: #fbbf24; --bttf-grad: linear-gradient(180deg, #ff9d00 0%, #ffbd00 45%, #ffff00 100%); }
        html, body { 
            margin: 0; padding: 0; width: 100vw; height: 100dvh; 
            background-color: var(--bg); overflow: hidden; position: fixed; inset: 0; 
            font-family: 'JetBrains Mono', monospace; color: white; user-select: text;
        }

        #viewport { position: absolute; inset: 0; display: flex; }

        aside {
            width: 220px; height: 100%; 
            background: var(--sidebar-bg); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 20;
        }

        .brand-header {
            padding: 15px; border-bottom: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 10px;
        }
        .brand-title { font-size: 11px; font-weight: 900; letter-spacing: 0.15em; color: #666; text-transform: uppercase; }
        .brand-version { color: #10b981; } /* Vert √âmeraude */
        .timer-badge { font-size: 10px; color: #10b981; font-weight: bold; white-space: nowrap; }

        #flux-container {
            flex: 0 0 35%; 
            border-bottom: 1px solid var(--border);
            padding: 15px; overflow: hidden; display: flex; flex-direction: column;
        }
        .section-title { font-size: 10px; color: var(--accent); font-weight: 800; text-transform: uppercase; margin-bottom: 8px; display: flex; justify-content: space-between; }
        #activity-list { overflow-y: auto; list-style: none; padding: 0; margin: 0; flex: 1; }
        #activity-list li { font-size: 10px; color: #bbb; margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.03); line-height: 1.4; }
        
        #legend-container { flex: 1; padding: 15px; overflow-y: auto; }
        .legend-item { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 8px; cursor: pointer; transition: opacity 0.2s; user-select: none; }
        .legend-text { font-size: 9px; color: #888; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        main { flex: 1; position: relative; height: 100%; background: var(--bg); display: flex; flex-direction: column; }
        
        .top-bar {
            height: 40px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: center; align-items: center; padding: 0 20px; position: relative;
        }
        .hud-btn { font-size: 10px; font-weight: 800; color: #666; text-transform: uppercase; cursor: pointer; transition: color 0.2s; }
        
        .bttf-btn {
            font-family: 'Inter', sans-serif; font-weight: 900; font-style: italic; letter-spacing: -0.5px;
            background: var(--bttf-grad); color: black;
            padding: 6px 16px; border-radius: 2px; border: none;
            box-shadow: 0 4px 15px rgba(255, 160, 0, 0.4); 
            transform: skewX(-10deg); font-size: 11px; text-transform: uppercase;
        }

        #loading-screen { 
            position: fixed; inset: 0; background: #010102; z-index: 9000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        #debug-log {
            width: 80%; max-width: 600px; height: 150px; 
            background: #000; border: 1px solid #333; 
            color: #10b981; font-size: 10px; padding: 10px; 
            overflow-y: auto; margin-top: 20px; font-family: 'JetBrains Mono';
        }

        #detail-card { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 650px; background: rgba(5,5,8,0.98); 
            border: 1px solid #333; padding: 2rem; z-index: 5000; display: none;
            box-shadow: 0 0 50px rgba(0,0,0,0.9);
        }
        #label-float { 
            position: fixed; pointer-events: none; background: rgba(0,0,0,0.9); 
            border: 1px solid var(--accent); color: #fff; padding: 5px 10px; 
            z-index: 4000; display: none; align-items: center; gap: 8px; font-size: 10px; 
            border-radius: 2px; font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="text-xl font-black text-white mb-2 tracking-widest">TRANSCENDANCE BOOT v148</div>
        <div class="text-xs text-zinc-500 mb-4">Initialisation de la matrice de convergence...</div>
        <div id="debug-log">System Init v148...</div>
    </div>

    <div id="viewport">
        <aside>
            <div class="brand-header">
                <div class="brand-title">Transcendance <span class="brand-version" onclick="location.reload(true)" style="cursor:pointer;" title="Force Reload">v148</span></div>
                <div id="timer-badge" class="timer-badge">Sync...</div>
            </div>
            <div id="flux-container">
                <div class="section-title"><span>Flux Entrant</span><span id="flux-count" class="text-zinc-500">0</span></div>
                <ul id="activity-list"></ul>
            </div>
            <div id="legend-container"></div>
        </aside>

        <main>
            <div class="top-bar">
                <span id="sync-status" class="text-[9px] font-bold text-zinc-600 absolute left-4">OFFLINE</span>
                <button onclick="resetView()" class="bttf-btn">RETOUR VERS LE FUTUR</button>
            </div>
            <div class="relative flex-1 w-full overflow-hidden">
                <canvas id="loomChart"></canvas>
            </div>
        </main>
    </div>

    <div id="label-float"><span id="label-text"></span></div>

    <div id="detail-card">
        <button onclick="closeDetail()" class="absolute top-4 right-4 text-zinc-500 hover:text-white text-2xl">&times;</button>
        <h2 id="card-title" class="text-2xl font-black text-amber-500 uppercase mb-2"></h2>
        <div class="flex gap-4 text-[10px] text-zinc-500 uppercase mb-4 border-b border-zinc-800 pb-2">
            <span>Source: <b id="card-who" class="text-zinc-300"></b></span>
            <span>Date: <b id="card-date" class="text-zinc-300"></b></span>
        </div>
        <div id="card-nav" class="flex flex-wrap gap-2 mb-4"></div>
        <p id="card-desc" class="text-zinc-300 italic text-sm leading-relaxed mb-6"></p>

        <div id="card-analysis-section" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs border-t border-zinc-800 pt-4">
            <div>
                <h3 class="font-bold text-amber-500 uppercase text-[10px] mb-2">Analyse Pharmakon</h3>
                <div class="w-full flex rounded-full h-2 bg-zinc-800 overflow-hidden">
                    <div id="pharmakon-remedy-bar" class="bg-emerald-500 h-2"></div>
                    <div id="pharmakon-poison-bar" class="bg-red-500 h-2"></div>
                </div>
                <div class="flex justify-between text-[9px] mt-1 uppercase">
                    <span class="text-emerald-400">Rem√®de: <b id="pharmakon-remedy"></b></span>
                    <span class="text-red-400">Poison: <b id="pharmakon-poison"></b></span>
                </div>
            </div>
            <div>
                <h3 class="font-bold text-amber-500 uppercase text-[10px] mb-2">Phase Courbe en S</h3>
                <div class="text-zinc-300"><b id="s-curve-phase" class="text-2xl font-mono mr-2"></b> / 5</div>
                <p id="s-curve-desc" class="text-zinc-500 text-[9px]"></p>
            </div>
            <div class="md:col-span-2">
                <h3 class="font-bold text-amber-500 uppercase text-[10px] mb-1">Convergences & Grand Filtre</h3>
                <p id="convergences-text" class="text-zinc-400 leading-tight"></p>
            </div>
        </div>
    </div>

    <script>
        const CLOUD_URL = 'https://script.google.com/macros/s/AKfycbwg-ZzMeSRyoaTRV-u824eQvnd8tHYxTsk-xDSK4vhYy42OnMpFrpumj2NSEaA45gP-/exec';
        const COLORS = { 
            "‚ö™ SINGULARIT√â": "#ffffff", "‚ú® NOOSPH√àRE": "#0ea5e9", "üîÆ IMAGINAIRE": "#f472b6", 
            "üü° HARDWARE": "#fbbf24", "üîµ COGNITION": "#3b82f6", "üî¥ R√âSEAU": "#ef4444", 
            "üü£ ESPACE": "#a855f7", "üü¢ BIOTECH": "#10b981", "‚ò¢Ô∏è ENTROPIE": "#f97316", "üèõÔ∏è POLITIQUE": "#d946ef", "DEFAUT": "#9ca3af" 
        };
        const ICONS = { "‚ö™ SINGULARIT√â": "üß†", "‚ú® NOOSPH√àRE": "üåç", "üîÆ IMAGINAIRE": "üìö", "üü° HARDWARE": "üíæ", "üîµ COGNITION": "‚ö°", "üî¥ R√âSEAU": "üåê", "üü£ ESPACE": "üöÄ", "üü¢ BIOTECH": "üß¨", "‚ò¢Ô∏è ENTROPIE": "‚ò¢Ô∏è", "üèõÔ∏è POLITIQUE": "‚öñÔ∏è" };

        let loomChart, activeCategory = null;

        function log(msg, type="info") {
            const el = document.getElementById('debug-log');
            el.innerHTML += `<div style="color:${type==='error'?'#ef4444':'#10b981'}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        async function loadData(init = false) {
            try {
                const res = await fetch(CLOUD_URL + '?t=' + Date.now());
                const json = await res.json();
                updateChart(json);
                updateFlux(json);
                updateLegend(json);
                if (init) {
                    setTimeout(() => document.getElementById('loading-screen').remove(), 1000);
                    resetView();
                }
                document.getElementById('sync-status').innerText = `SYNC OK ${new Date().toLocaleTimeString()}`;
            } catch(e) { log("Erreur Sync: " + e.message, "error"); }
        }

        function updateChart(data) {
            const datasets = {};
            data.sort((a,b) => a.year - b.year).forEach(d => {
                const cat = d.category || "DEFAUT";
                if (!datasets[cat]) datasets[cat] = { label: cat, borderColor: COLORS[cat], backgroundColor: COLORS[cat], data: [], pointRadius: 4, hitRadius: 20, tension: 0.3 };
                datasets[cat].data.push({ x: d.year, y: d.value, ...d });
            });
            loomChart.data.datasets = Object.values(datasets);
            loomChart.update();
        }

        function updateFlux(data) {
            const list = document.getElementById('activity-list');
            list.innerHTML = '';
            data.slice(-10).reverse().forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<span style="color:${COLORS[item.category]}">${ICONS[item.category] || '‚óè'}</span> ${item.label}`;
                list.appendChild(li);
            });
        }

        function updateLegend(data) {
            const container = document.getElementById('legend-container');
            container.innerHTML = `<div class="section-title"><span>Strands</span></div>`;
            Object.keys(COLORS).forEach(cat => {
                if (cat === "DEFAUT") return;
                const div = document.createElement('div');
                div.className = 'legend-item';
                div.innerHTML = `<div class="flex items-center gap-2"><div style="width:8px;height:8px;background:${COLORS[cat]}"></div><span class="legend-text">${cat}</span></div>`;
                div.onclick = () => {
                    activeCategory = (activeCategory === cat) ? null : cat;
                    loomChart.data.datasets.forEach(ds => ds.hidden = activeCategory && ds.label !== activeCategory);
                    loomChart.update();
                };
                container.appendChild(div);
            });
        }

        function showDetail(d) {
            document.getElementById('card-title').innerText = d.label;
            document.getElementById('card-who').innerText = d.whoWhat || "Inconnu";
            document.getElementById('card-date').innerText = Math.floor(d.x);
            document.getElementById('card-desc').innerText = d.description || "Analyse en cours...";
            
            const nav = document.getElementById('card-nav');
            nav.innerHTML = '';
            
            // Logique de maillage (v148) : Recherche des √©l√©ments produits ou pr√©dits
            const allPoints = loomChart.data.datasets.flatMap(ds => ds.data);
            
            if (d.realYear) {
                const targets = allPoints.filter(p => Math.abs(p.x - d.realYear) < 0.8);
                targets.forEach(t => {
                    const btn = document.createElement('button');
                    btn.className = "px-2 py-1 bg-zinc-800 border border-zinc-600 text-[9px] hover:bg-zinc-700 uppercase";
                    btn.innerText = `‚ñ∂ R√âALISATION : ${t.label}`;
                    btn.onclick = () => { zoomTo(t.x); showDetail(t); };
                    nav.appendChild(btn);
                });
            }

            if (d.predictedBy) {
                const preds = Array.isArray(d.predictedBy) ? d.predictedBy : [d.predictedBy];
                preds.forEach(pLabel => {
                    const pPoint = allPoints.find(p => p.label === pLabel);
                    if (pPoint) {
                        const btn = document.createElement('button');
                        btn.className = "px-2 py-1 bg-zinc-800 border border-zinc-600 text-[9px] hover:bg-zinc-700 uppercase";
                        btn.innerText = `‚óÄ PR√âDIT PAR : ${pPoint.label}`;
                        btn.onclick = () => { zoomTo(pPoint.x); showDetail(pPoint); };
                        nav.appendChild(btn);
                    }
                });
            }

            document.getElementById('pharmakon-remedy-bar').style.width = `${d.pharmakon_remedy_percent}%`;
            document.getElementById('pharmakon-poison-bar').style.width = `${d.pharmakon_poison_percent}%`;
            document.getElementById('pharmakon-remedy').innerText = `${d.pharmakon_remedy_percent}%`;
            document.getElementById('pharmakon-poison').innerText = `${d.pharmakon_poison_percent}%`;
            document.getElementById('s-curve-phase').innerText = d.s_curve_phase || "?";
            document.getElementById('convergences-text').innerText = d.convergences || d.grand_filter_analysis || "Donn√©es manquantes.";

            document.getElementById('detail-card').style.display = 'block';
        }

        function zoomTo(year) {
            loomChart.options.scales.x.min = year - 5;
            loomChart.options.scales.x.max = year + 5;
            loomChart.update();
        }

        function resetView() { zoomTo(1985); }
        function closeDetail() { document.getElementById('detail-card').style.display = 'none'; }

        window.onload = () => {
            loomChart = new Chart(document.getElementById('loomChart'), {
                type: 'line',
                data: { datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onClick: (e, el) => { if(el.length) showDetail(loomChart.data.datasets[el[0].datasetIndex].data[el[0].index]); },
                    scales: {
                        x: { type: 'linear', grid: { color: '#111' }, ticks: { color: '#444' } },
                        y: { type: 'logarithmic', position: 'right', grid: { color: '#050505' } }
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            color: '#fff', font: { size: 9, weight: 'bold' },
                            backgroundColor: c => c.dataset.borderColor,
                            formatter: v => v.tipping || (loomChart.scales.x.max - loomChart.scales.x.min < 15) ? v.label : null,
                            padding: 3, borderRadius: 2, clip: true
                        },
                        zoom: { zoom: { wheel: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'x' } }
                    }
                }
            });
            loadData(true);
            setInterval(loadData, 300000);
        };
    </script>
</body>
</html>